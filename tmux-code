#!/usr/bin/env bash
#
# tmux-code - A VS Code-inspired terminal IDE using tmux
#
# Creates a tmux session with a 3-panel layout:
#   - Left: File explorer (lf/ranger/tree)
#   - Middle: Editor (nvim/vim) + Terminal
#   - Right: AI assistant (claude/aider) - optional
#

set -euo pipefail

# ============================================================================
# Argument Parsing (0h6.4.1)
# ============================================================================

# Global variables for parsed arguments
TMUX_CODE_PATH="."
TMUX_CODE_AGENT=""
TMUX_CODE_NO_AGENT=false
TMUX_CODE_NEW=false
TMUX_CODE_HELP=false
TMUX_CODE_COMMAND=""  # Subcommand: toggle-mode, etc.

# Parse command line arguments
# Arguments: "$@"
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            toggle-mode)
                # Subcommand for toggling left panel mode
                TMUX_CODE_COMMAND="toggle-mode"
                shift
                ;;
            --agent)
                if [[ $# -lt 2 || "$2" == --* ]]; then
                    echo "Error: --agent requires a command argument" >&2
                    exit 1
                fi
                TMUX_CODE_AGENT="$2"
                shift 2
                ;;
            --no-agent)
                TMUX_CODE_NO_AGENT=true
                shift
                ;;
            --new)
                TMUX_CODE_NEW=true
                shift
                ;;
            --help|-h)
                TMUX_CODE_HELP=true
                shift
                ;;
            -*)
                echo "Error: Unknown option: $1" >&2
                echo "Run 'tmux-code --help' for usage information." >&2
                exit 1
                ;;
            *)
                # Positional argument = path
                TMUX_CODE_PATH="$1"
                shift
                ;;
        esac
    done
}

# ============================================================================
# Help Output (0h6.4.2)
# ============================================================================

# Display help message
show_help() {
    cat << 'EOF'
tmux-code - A VS Code-inspired terminal IDE using tmux

USAGE:
    tmux-code [PATH] [OPTIONS]

ARGUMENTS:
    [PATH]              Directory to open (default: current directory)

OPTIONS:
    --agent <cmd>       Use specified AI agent command instead of auto-detecting
    --no-agent          Disable AI agent panel entirely
    --new               Force create new session (skip attach/recreate prompt)
    -h, --help          Show this help message

EXAMPLES:
    tmux-code                    Open current directory
    tmux-code ~/projects/myapp   Open specified directory
    tmux-code --no-agent         Open without AI assistant panel
    tmux-code --agent "aider"    Use aider as the AI agent
    tmux-code --new              Force new session creation

LAYOUT:
    The layout adapts based on available tools:
    - 3-column: File explorer | Editor + Terminal | AI agent
    - 2-column: File explorer | Editor + Terminal (no AI)
    - Editor only: Editor + Terminal (no file explorer)

TOOL DETECTION:
    File explorer: lf → ranger → tree
    Editor: $EDITOR → nvim → vim
    AI agent: claude → aider (or specify with --agent)
EOF
}

# ============================================================================
# Keybindings File (v0.2 - tmux-code-2d4.2.2)
# ============================================================================

# Keybindings config location
readonly KEYBINDINGS_FILE="${HOME}/.config/tmux-code/bindings.conf"

# Generate keybindings file if it doesn't exist
# Creates ~/.config/tmux-code/bindings.conf with tmux-code keybindings
generate_keybindings_file() {
    local config_dir
    config_dir=$(dirname "$KEYBINDINGS_FILE")

    # Create config directory if needed
    if [[ ! -d "$config_dir" ]]; then
        mkdir -p "$config_dir"
    fi

    # Get base pane index for correct keybindings
    local pane_base
    pane_base=$(get_pane_base_index)

    # Get absolute path to this script for keybindings
    local script_path
    script_path=$(realpath "${BASH_SOURCE[0]}")

    # Generate keybindings file with dynamic pane indices
    cat > "$KEYBINDINGS_FILE" << EOF
# tmux-code keybindings
# Generated by tmux-code - edit with care, may be regenerated
# Pane indices based on pane-base-index: ${pane_base}

# Pane Navigation (vim-style hjkl)
bind-key h select-pane -L
bind-key j select-pane -D
bind-key k select-pane -U
bind-key l select-pane -R

# Left Panel Mode Toggle (g = git mode toggle)
bind-key g run-shell "${script_path} toggle-mode"

# Quick Pane Focus (indices relative to pane-base-index)
bind-key e select-pane -t ${pane_base}   # Explorer (left panel)
bind-key m select-pane -t $((pane_base + 1))   # Main editor
bind-key t select-pane -t $((pane_base + 2))   # Terminal
bind-key a select-pane -t $((pane_base + 3))   # AI agent (if exists)

# Pane Resizing (vim-style with Shift)
bind-key H resize-pane -L 5
bind-key J resize-pane -D 5
bind-key K resize-pane -U 5
bind-key L resize-pane -R 5
EOF

    echo "Generated keybindings file: $KEYBINDINGS_FILE"
}

# Source keybindings file for a session
# Arguments: $1 - session name
source_keybindings() {
    local session="$1"

    # Always regenerate keybindings file to pick up any pane-base-index changes
    generate_keybindings_file

    # Source the keybindings in the session
    tmux source-file "$KEYBINDINGS_FILE"
}

# ============================================================================
# Tmux Base Index Detection
# ============================================================================

# Get the base window index (default 0, but user may have set to 1)
get_base_index() {
    tmux show-option -gv base-index 2>/dev/null || echo "0"
}

# Get the base pane index (default 0, but user may have set to 1)
get_pane_base_index() {
    tmux show-option -gv pane-base-index 2>/dev/null || echo "0"
}

# ============================================================================
# Workspace Name Detection (0h6.1.1)
# ============================================================================

# Get workspace name from git repo name or fallback to directory name
get_workspace_name() {
    local dir="${1:-.}"
    local abs_dir
    abs_dir=$(cd "$dir" && pwd)

    # Try git repo name first
    local git_name
    git_name=$(git -C "$abs_dir" rev-parse --show-toplevel 2>/dev/null | xargs basename 2>/dev/null) || true

    if [[ -n "${git_name:-}" ]]; then
        echo "$git_name"
        return
    fi

    # Fall back to directory name
    basename "$abs_dir"
}

# Get the session name (same as workspace name)
get_session_name() {
    get_workspace_name "${1:-.}"
}

# ============================================================================
# Session Exists Prompt (0h6.1.3)
# ============================================================================

# Check if session exists and prompt user for action
# Returns: 0 = attach, 1 = recreate, 2 = cancel
prompt_session_exists() {
    local session_name="$1"

    echo "Session '$session_name' already exists."
    echo ""
    echo "  [a] Attach to existing session"
    echo "  [r] Kill and recreate session"
    echo "  [c] Cancel"
    echo ""

    while true; do
        read -r -p "Choose action [a/r/c]: " choice
        case "${choice,,}" in
            a|attach)
                return 0
                ;;
            r|recreate)
                return 1
                ;;
            c|cancel)
                return 2
                ;;
            *)
                echo "Invalid choice. Please enter a, r, or c."
                ;;
        esac
    done
}

# ============================================================================
# Tool Detection (0h6.3.1, 0h6.3.2, 0h6.3.3)
# ============================================================================

# Detect file explorer: lf → ranger → tree fallback chain
# Returns: command name or empty string if none available
detect_file_explorer() {
    if command -v lf &>/dev/null; then
        echo "lf"
    elif command -v ranger &>/dev/null; then
        echo "ranger"
    elif command -v tree &>/dev/null; then
        echo "tree"
    else
        echo ""
    fi
}

# Wrap explorer command for execution
# tree needs watch mode since it's not interactive like lf/ranger
# Arguments: $1 - explorer command from detect_file_explorer
wrap_explorer_cmd() {
    local cmd="$1"
    if [[ "$cmd" == "tree" ]]; then
        # Use watch for auto-refresh, -C for color
        echo "watch -n 2 -c 'tree -C -L 3'"
    else
        echo "$cmd"
    fi
}

# Detect editor: $EDITOR → nvim → vim fallback chain
# Returns: command name or empty string if none available
detect_editor() {
    # First, respect $EDITOR environment variable if set and valid
    if [[ -n "${EDITOR:-}" ]]; then
        # Extract the base command (in case $EDITOR has flags like "vim -u NONE")
        local editor_base="${EDITOR%% *}"
        if command -v "$editor_base" &>/dev/null; then
            echo "$EDITOR"
            return
        fi
    fi

    # Fallback chain: nvim → vim
    if command -v nvim &>/dev/null; then
        echo "nvim"
    elif command -v vim &>/dev/null; then
        echo "vim"
    else
        echo ""
    fi
}

# Detect AI agent: check multiple AI coding tools
# Priority order: claude, aider, goose, copilot, cody, gpt, codex
# Returns: command name or empty string if none available
detect_ai_agent() {
    # Claude Code (Anthropic)
    if command -v claude &>/dev/null; then
        echo "claude"
    # Aider (popular AI pair programming)
    elif command -v aider &>/dev/null; then
        echo "aider"
    # Goose (Block's AI agent)
    elif command -v goose &>/dev/null; then
        echo "goose"
    # GitHub Copilot CLI
    elif command -v copilot &>/dev/null; then
        echo "copilot"
    # Sourcegraph Cody CLI
    elif command -v cody &>/dev/null; then
        echo "cody"
    # OpenAI GPT CLI
    elif command -v gpt &>/dev/null; then
        echo "gpt"
    # OpenAI Codex
    elif command -v codex &>/dev/null; then
        echo "codex"
    else
        echo ""
    fi
}

# ============================================================================
# Left Panel Mode System (v0.2 - 0h6.2d4.1)
# ============================================================================

# Mode constants
readonly MODE_EXPLORER="explorer"
readonly MODE_GIT="git"

# Get the current left panel mode
# Returns: "explorer" or "git"
get_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local mode
    mode=$(tmux show-environment -t "$session" TMUX_CODE_LEFT_MODE 2>/dev/null | cut -d= -f2)
    echo "${mode:-$MODE_EXPLORER}"  # Default to explorer
}

# Set the left panel mode
set_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local mode="$2"
    tmux set-environment -t "$session" TMUX_CODE_LEFT_MODE "$mode"
}

# Start explorer mode in the left panel (pane base)
# This is the default mode showing lf/ranger/tree file explorer
start_explorer_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local explorer_cmd
    explorer_cmd=$(detect_file_explorer)

    if [[ -z "$explorer_cmd" ]]; then
        echo "No file explorer available (lf, ranger, or tree)"
        return 1
    fi

    # Wrap explorer command (tree needs watch mode)
    local wrapped_explorer
    wrapped_explorer=$(wrap_explorer_cmd "$explorer_cmd")

    # Get base indices
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Kill any existing process in left pane and start explorer
    tmux send-keys -t "${session}:${win_base}.${pane_base}" C-c
    sleep 0.1
    tmux send-keys -t "${session}:${win_base}.${pane_base}" "$wrapped_explorer" Enter

    # Set pane title
    tmux select-pane -t "${session}:${win_base}.${pane_base}" -T "Explorer"

    # Update mode tracking
    set_left_panel_mode "$session" "$MODE_EXPLORER"
}

# Start git mode in the left panel (pane base)
# Shows git status --short (top) and git log --oneline (bottom) in a split pane
# Uses watch to auto-refresh git status
start_git_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"

    # Get base indices
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Kill any existing process in left pane
    tmux send-keys -t "${session}:${win_base}.${pane_base}" C-c
    sleep 0.1

    # Create status view with watch for auto-refresh (top pane)
    tmux send-keys -t "${session}:${win_base}.${pane_base}" "watch -n 2 -c --no-wrap 'git -c color.status=always status --short'" Enter

    # Set pane title for git status
    tmux select-pane -t "${session}:${win_base}.${pane_base}" -T "Git Status"

    # Split horizontally and create log view
    # The new pane becomes active after split-window
    tmux split-window -t "${session}:${win_base}.${pane_base}" -v -l 50%

    # Get the pane_id of the newly created (now active) pane
    local new_pane_id
    new_pane_id=$(tmux display-message -t "${session}" -p '#{pane_id}')

    # Start log view in the new pane (which is now active)
    tmux send-keys -t "$new_pane_id" "watch -n 5 -c --no-wrap 'git log --oneline --color=always -20'" Enter

    # Set pane title for git log
    tmux select-pane -t "$new_pane_id" -T "Git Log"

    # Store the git log pane id for cleanup
    tmux set-environment -t "$session" TMUX_CODE_GIT_LOG_PANE "$new_pane_id"

    # Update mode tracking
    set_left_panel_mode "$session" "$MODE_GIT"
}

# Toggle between explorer and git modes in the left panel
# This is called by the keybinding to switch modes
toggle_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local current_mode
    current_mode=$(get_left_panel_mode "$session")

    if [[ "$current_mode" == "$MODE_EXPLORER" ]]; then
        # Switch to git mode
        start_git_mode "$session"
    else
        # Switch back to explorer mode
        # First, kill the git log pane if it exists
        local git_log_pane_id
        git_log_pane_id=$(tmux show-environment -t "$session" TMUX_CODE_GIT_LOG_PANE 2>/dev/null | cut -d= -f2)
        if [[ -n "$git_log_pane_id" ]]; then
            # Kill the git log pane by its pane_id (e.g., %5)
            tmux kill-pane -t "$git_log_pane_id" 2>/dev/null || true
            tmux set-environment -t "$session" -u TMUX_CODE_GIT_LOG_PANE
        fi

        # Start explorer mode
        start_explorer_mode "$session"
    fi
}

# ============================================================================
# Launch Commands in Panes (0h6.3.4)
# ============================================================================

# Launch detected commands in appropriate panes
# Arguments:
#   $1 - session name
#   $2 - layout type: "3col" | "2col" | "editor"
#   $3 - file explorer command (can be empty)
#   $4 - editor command (can be empty)
#   $5 - ai agent command (can be empty, only used for 3col)
launch_commands_in_panes() {
    local session="$1"
    local layout="$2"
    local explorer_cmd="$3"
    local editor_cmd="$4"
    local ai_cmd="${5:-}"

    # Get base indices (user may have set base-index/pane-base-index to 1)
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Wrap explorer command (tree needs watch mode)
    local wrapped_explorer
    wrapped_explorer=$(wrap_explorer_cmd "$explorer_cmd")

    case "$layout" in
        3col)
            # Pane base+0: file explorer, Pane base+1: editor, Pane base+2: terminal, Pane base+3: AI
            if [[ -n "$explorer_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.${pane_base}" "$wrapped_explorer" Enter
                tmux select-pane -t "${session}:${win_base}.${pane_base}" -T "Explorer"
                set_left_panel_mode "$session" "$MODE_EXPLORER"
            fi
            if [[ -n "$editor_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.$((pane_base + 1))" "$editor_cmd ." Enter
                tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))" -T "Editor"
            fi
            tmux select-pane -t "${session}:${win_base}.$((pane_base + 2))" -T "Terminal"
            if [[ -n "$ai_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.$((pane_base + 3))" "$ai_cmd" Enter
                tmux select-pane -t "${session}:${win_base}.$((pane_base + 3))" -T "AI Agent"
            fi
            ;;
        2col)
            # Pane base+0: file explorer, Pane base+1: editor, Pane base+2: terminal
            if [[ -n "$explorer_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.${pane_base}" "$wrapped_explorer" Enter
                tmux select-pane -t "${session}:${win_base}.${pane_base}" -T "Explorer"
                set_left_panel_mode "$session" "$MODE_EXPLORER"
            fi
            if [[ -n "$editor_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.$((pane_base + 1))" "$editor_cmd ." Enter
                tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))" -T "Editor"
            fi
            tmux select-pane -t "${session}:${win_base}.$((pane_base + 2))" -T "Terminal"
            ;;
        editor)
            # Pane base+0: editor, Pane base+1: terminal (no left panel mode)
            if [[ -n "$editor_cmd" ]]; then
                tmux send-keys -t "${session}:${win_base}.${pane_base}" "$editor_cmd ." Enter
                tmux select-pane -t "${session}:${win_base}.${pane_base}" -T "Editor"
            fi
            tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))" -T "Terminal"
            ;;
    esac
}

# ============================================================================
# Status Bar (v0.3 - tmux-code-70p.1.1)
# ============================================================================

# Configure the tmux status bar for a session
# Shows: session name | git branch | mode indicator
configure_status_bar() {
    local session="$1"

    # Status bar general settings
    tmux set-option -t "$session" status on
    tmux set-option -t "$session" status-interval 5
    tmux set-option -t "$session" status-position bottom

    # Colors: dark theme to match typical terminal aesthetics
    tmux set-option -t "$session" status-style "bg=colour235,fg=colour248"

    # Left side: session name
    tmux set-option -t "$session" status-left-length 30
    tmux set-option -t "$session" status-left "#[fg=colour117,bold] #S #[fg=colour245]│ "

    # Right side: git branch and mode indicator
    # Git branch uses shell command to get current branch
    # Mode indicator reads from tmux environment variable
    tmux set-option -t "$session" status-right-length 60
    tmux set-option -t "$session" status-right "#[fg=colour245]│ #[fg=colour114]󰊢 #(git -C '#{pane_current_path}' branch --show-current 2>/dev/null || echo 'no-git') #[fg=colour245]│ #[fg=colour223]#{?#{==:#{TMUX_CODE_LEFT_MODE},git},󰊢 git,󰙅 explorer}"

    # Window/pane status (middle section)
    tmux set-option -t "$session" window-status-format " #I:#W "
    tmux set-option -t "$session" window-status-current-format "#[fg=colour117,bold] #I:#W "
    tmux set-option -t "$session" window-status-separator ""

    # Pane border settings - show pane titles at top of each pane
    tmux set-option -t "$session" pane-border-status top
    tmux set-option -t "$session" pane-border-format " #{pane_title} "
    tmux set-option -t "$session" pane-border-style "fg=colour238"
    tmux set-option -t "$session" pane-active-border-style "fg=colour117"

    # Disable automatic window renaming (prevents "watch" showing as window name)
    tmux set-option -t "$session" automatic-rename off
    tmux set-option -t "$session" allow-rename off
}

# ============================================================================
# Layout Creation (0h6.2.1, 0h6.2.2, 0h6.2.3)
# ============================================================================

# Create 3-column layout with AI panel
# Layout: Left (15%) | Middle-Editor (50%) + Terminal | Right-AI (35%)
# Middle is split: Editor (70%) / Terminal (30%)
create_3_column_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window (this starts the server if needed)
    tmux new-session -d -s "$session" -c "$working_dir"

    # Get base indices AFTER session creation (server must be running)
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Split vertically: left (15%) | rest (85%)
    tmux split-window -t "${session}:${win_base}" -h -l 85% -c "$working_dir"

    # Select right pane (pane base+1), split vertically: middle (59%) | right (41%)
    # 59% of 85% ≈ 50% total, 41% of 85% ≈ 35% total
    tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))"
    tmux split-window -t "${session}:${win_base}" -h -l 41% -c "$working_dir"

    # Select middle pane (pane base+1), split horizontally: editor (70%) | terminal (30%)
    tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))"
    tmux split-window -t "${session}:${win_base}" -v -l 30% -c "$working_dir"

    # Pane layout now (indices relative to pane_base):
    # Pane base+0: Left (file explorer)
    # Pane base+1: Middle-top (editor)
    # Pane base+2: Middle-bottom (terminal)
    # Pane base+3: Right (AI assistant)

    # Focus on editor pane
    tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))"
}

# Create 2-column layout without AI panel (0h6.2.2)
# Layout: Left (20%) | Right-Editor (80%) + Terminal
# Right is split: Editor (70%) / Terminal (30%)
create_2_column_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window (this starts the server if needed)
    tmux new-session -d -s "$session" -c "$working_dir"

    # Get base indices AFTER session creation (server must be running)
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Split vertically: left (20%) | right (80%)
    tmux split-window -t "${session}:${win_base}" -h -l 80% -c "$working_dir"

    # Select right pane (pane base+1), split horizontally: editor (70%) | terminal (30%)
    tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))"
    tmux split-window -t "${session}:${win_base}" -v -l 30% -c "$working_dir"

    # Pane layout now (indices relative to pane_base):
    # Pane base+0: Left (file explorer)
    # Pane base+1: Right-top (editor)
    # Pane base+2: Right-bottom (terminal)

    # Focus on editor pane
    tmux select-pane -t "${session}:${win_base}.$((pane_base + 1))"
}

# Create editor/terminal split layout (0h6.2.3)
# Simple 2-pane layout: Editor (70%) / Terminal (30%)
# Used when no file explorer is available
create_editor_terminal_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window (this starts the server if needed)
    tmux new-session -d -s "$session" -c "$working_dir"

    # Get base indices AFTER session creation (server must be running)
    local win_base pane_base
    win_base=$(get_base_index)
    pane_base=$(get_pane_base_index)

    # Split horizontally: editor (70%) | terminal (30%)
    tmux split-window -t "${session}:${win_base}" -v -l 30% -c "$working_dir"

    # Pane layout now (indices relative to pane_base):
    # Pane base+0: Top (editor)
    # Pane base+1: Bottom (terminal)

    # Focus on editor pane
    tmux select-pane -t "${session}:${win_base}.${pane_base}"
}

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    # Parse arguments
    parse_args "$@"

    # Handle help flag
    if [[ "$TMUX_CODE_HELP" == true ]]; then
        show_help
        return 0
    fi

    # Handle subcommands
    if [[ "$TMUX_CODE_COMMAND" == "toggle-mode" ]]; then
        toggle_left_panel_mode
        return 0
    fi

    # Resolve to absolute path
    local abs_path
    abs_path=$(cd "$TMUX_CODE_PATH" && pwd)

    # Get session name
    local session_name
    session_name=$(get_session_name "$TMUX_CODE_PATH")

    # Check if session already exists (unless --new forces recreation)
    if tmux has-session -t "$session_name" 2>/dev/null; then
        if [[ "$TMUX_CODE_NEW" == true ]]; then
            echo "Killing session '$session_name'..."
            tmux kill-session -t "$session_name"
        else
            prompt_session_exists "$session_name"
            local action=$?

            case $action in
                0)  # Attach
                    tmux attach-session -t "$session_name"
                    return 0
                    ;;
                1)  # Recreate
                    echo "Killing session '$session_name'..."
                    tmux kill-session -t "$session_name"
                    ;;
                2)  # Cancel
                    echo "Cancelled."
                    return 0
                    ;;
            esac
        fi
    fi

    # Detect available tools
    local explorer_cmd
    local editor_cmd
    local ai_cmd
    explorer_cmd=$(detect_file_explorer)
    editor_cmd=$(detect_editor)

    # Handle AI agent: --no-agent disables, --agent overrides, otherwise auto-detect
    if [[ "$TMUX_CODE_NO_AGENT" == true ]]; then
        ai_cmd=""
    elif [[ -n "$TMUX_CODE_AGENT" ]]; then
        ai_cmd="$TMUX_CODE_AGENT"
    else
        ai_cmd=$(detect_ai_agent)
    fi

    # Determine layout based on available tools
    local layout
    if [[ -n "$ai_cmd" && -n "$explorer_cmd" ]]; then
        layout="3col"
    elif [[ -n "$explorer_cmd" ]]; then
        layout="2col"
    else
        layout="editor"
    fi

    # Create session with appropriate layout
    echo "Creating session: $session_name"
    case "$layout" in
        3col)
            create_3_column_layout "$session_name" "$abs_path"
            ;;
        2col)
            create_2_column_layout "$session_name" "$abs_path"
            ;;
        editor)
            create_editor_terminal_layout "$session_name" "$abs_path"
            ;;
    esac

    # Set window name to "tmux-code" (session already has workspace name)
    local win_base
    win_base=$(get_base_index)
    tmux rename-window -t "${session_name}:${win_base}" "tmux-code"

    # Source keybindings
    source_keybindings "$session_name"

    # Configure status bar
    configure_status_bar "$session_name"

    # Launch commands in panes
    launch_commands_in_panes "$session_name" "$layout" "$explorer_cmd" "$editor_cmd" "$ai_cmd"

    # Attach to session
    tmux attach-session -t "$session_name"
}

# Run main if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
