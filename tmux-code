#!/usr/bin/env bash
#
# tmux-code - A VS Code-inspired terminal IDE using tmux
#
# Creates a tmux session with a 3-panel layout:
#   - Left: File explorer (lf/ranger/tree)
#   - Middle: Editor (nvim/vim) + Terminal
#   - Right: AI assistant (claude/aider) - optional
#

set -euo pipefail

# ============================================================================
# Argument Parsing (0h6.4.1)
# ============================================================================

# Global variables for parsed arguments
TMUX_CODE_PATH="."
TMUX_CODE_AGENT=""
TMUX_CODE_NO_AGENT=false
TMUX_CODE_NEW=false
TMUX_CODE_HELP=false

# Parse command line arguments
# Arguments: "$@"
parse_args() {
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --agent)
                if [[ $# -lt 2 || "$2" == --* ]]; then
                    echo "Error: --agent requires a command argument" >&2
                    exit 1
                fi
                TMUX_CODE_AGENT="$2"
                shift 2
                ;;
            --no-agent)
                TMUX_CODE_NO_AGENT=true
                shift
                ;;
            --new)
                TMUX_CODE_NEW=true
                shift
                ;;
            --help|-h)
                TMUX_CODE_HELP=true
                shift
                ;;
            -*)
                echo "Error: Unknown option: $1" >&2
                echo "Run 'tmux-code --help' for usage information." >&2
                exit 1
                ;;
            *)
                # Positional argument = path
                TMUX_CODE_PATH="$1"
                shift
                ;;
        esac
    done
}

# ============================================================================
# Help Output (0h6.4.2)
# ============================================================================

# Display help message
show_help() {
    cat << 'EOF'
tmux-code - A VS Code-inspired terminal IDE using tmux

USAGE:
    tmux-code [PATH] [OPTIONS]

ARGUMENTS:
    [PATH]              Directory to open (default: current directory)

OPTIONS:
    --agent <cmd>       Use specified AI agent command instead of auto-detecting
    --no-agent          Disable AI agent panel entirely
    --new               Force create new session (skip attach/recreate prompt)
    -h, --help          Show this help message

EXAMPLES:
    tmux-code                    Open current directory
    tmux-code ~/projects/myapp   Open specified directory
    tmux-code --no-agent         Open without AI assistant panel
    tmux-code --agent "aider"    Use aider as the AI agent
    tmux-code --new              Force new session creation

LAYOUT:
    The layout adapts based on available tools:
    - 3-column: File explorer | Editor + Terminal | AI agent
    - 2-column: File explorer | Editor + Terminal (no AI)
    - Editor only: Editor + Terminal (no file explorer)

TOOL DETECTION:
    File explorer: lf → ranger → tree
    Editor: nvim → vim
    AI agent: claude → aider (or specify with --agent)
EOF
}

# ============================================================================
# Workspace Name Detection (0h6.1.1)
# ============================================================================

# Get workspace name from git repo name or fallback to directory name
get_workspace_name() {
    local dir="${1:-.}"
    local abs_dir
    abs_dir=$(cd "$dir" && pwd)

    # Try git repo name first
    local git_name
    git_name=$(git -C "$abs_dir" rev-parse --show-toplevel 2>/dev/null | xargs basename 2>/dev/null) || true

    if [[ -n "${git_name:-}" ]]; then
        echo "$git_name"
        return
    fi

    # Fall back to directory name
    basename "$abs_dir"
}

# Get the session name (prefixed with "code-")
get_session_name() {
    local workspace
    workspace=$(get_workspace_name "${1:-.}")
    echo "code-${workspace}"
}

# ============================================================================
# Session Exists Prompt (0h6.1.3)
# ============================================================================

# Check if session exists and prompt user for action
# Returns: 0 = attach, 1 = recreate, 2 = cancel
prompt_session_exists() {
    local session_name="$1"

    echo "Session '$session_name' already exists."
    echo ""
    echo "  [a] Attach to existing session"
    echo "  [r] Kill and recreate session"
    echo "  [c] Cancel"
    echo ""

    while true; do
        read -r -p "Choose action [a/r/c]: " choice
        case "${choice,,}" in
            a|attach)
                return 0
                ;;
            r|recreate)
                return 1
                ;;
            c|cancel)
                return 2
                ;;
            *)
                echo "Invalid choice. Please enter a, r, or c."
                ;;
        esac
    done
}

# ============================================================================
# Tool Detection (0h6.3.1, 0h6.3.2, 0h6.3.3)
# ============================================================================

# Detect file explorer: lf → ranger → tree fallback chain
# Returns: command name or empty string if none available
detect_file_explorer() {
    if command -v lf &>/dev/null; then
        echo "lf"
    elif command -v ranger &>/dev/null; then
        echo "ranger"
    elif command -v tree &>/dev/null; then
        echo "tree -C"
    else
        echo ""
    fi
}

# Detect editor: nvim → vim fallback chain
# Returns: command name or empty string if none available
detect_editor() {
    if command -v nvim &>/dev/null; then
        echo "nvim"
    elif command -v vim &>/dev/null; then
        echo "vim"
    else
        echo ""
    fi
}

# Detect AI agent: claude → aider fallback chain
# Returns: command name or empty string if none available
detect_ai_agent() {
    if command -v claude &>/dev/null; then
        echo "claude"
    elif command -v aider &>/dev/null; then
        echo "aider"
    else
        echo ""
    fi
}

# ============================================================================
# Left Panel Mode System (v0.2 - 0h6.2d4.1)
# ============================================================================

# Mode constants
readonly MODE_EXPLORER="explorer"
readonly MODE_GIT="git"

# Get the current left panel mode
# Returns: "explorer" or "git"
get_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local mode
    mode=$(tmux show-environment -t "$session" TMUX_CODE_LEFT_MODE 2>/dev/null | cut -d= -f2)
    echo "${mode:-$MODE_EXPLORER}"  # Default to explorer
}

# Set the left panel mode
set_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local mode="$2"
    tmux set-environment -t "$session" TMUX_CODE_LEFT_MODE "$mode"
}

# Start explorer mode in the left panel (pane 0)
# This is the default mode showing lf/ranger/tree file explorer
start_explorer_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local explorer_cmd
    explorer_cmd=$(detect_file_explorer)

    if [[ -z "$explorer_cmd" ]]; then
        echo "No file explorer available (lf, ranger, or tree)"
        return 1
    fi

    # Kill any existing process in pane 0 and start explorer
    tmux send-keys -t "${session}:0.0" C-c
    sleep 0.1
    tmux send-keys -t "${session}:0.0" "$explorer_cmd" Enter

    # Update mode tracking
    set_left_panel_mode "$session" "$MODE_EXPLORER"
}

# Start git mode in the left panel (pane 0)
# Shows git status --short (top) and git log --oneline (bottom) in a split pane
# Uses watch to auto-refresh git status
start_git_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"

    # Kill any existing process in pane 0
    tmux send-keys -t "${session}:0.0" C-c
    sleep 0.1

    # Split pane 0 horizontally: status (top 50%) | log (bottom 50%)
    # First check if there's already a git-mode split (pane 0 has a nested split)
    local pane_count
    pane_count=$(tmux list-panes -t "${session}:0" | wc -l)

    # Create status view with watch for auto-refresh (top pane)
    tmux send-keys -t "${session}:0.0" "watch -n 2 -c 'git status --short'" Enter

    # Split horizontally and create log view (bottom pane becomes new last pane)
    tmux split-window -t "${session}:0.0" -v -l 50% -c "#{pane_current_path}"

    # Get the new pane index (it becomes the last pane)
    local new_pane_idx
    new_pane_idx=$((pane_count))

    # Start log view in the new bottom pane with watch for auto-refresh
    tmux send-keys -t "${session}:0.${new_pane_idx}" "watch -n 5 -c 'git log --oneline -20'" Enter

    # Store the git log pane index for cleanup
    tmux set-environment -t "$session" TMUX_CODE_GIT_LOG_PANE "$new_pane_idx"

    # Update mode tracking
    set_left_panel_mode "$session" "$MODE_GIT"
}

# Toggle between explorer and git modes in the left panel
# This is called by the keybinding to switch modes
toggle_left_panel_mode() {
    local session="${1:-$(tmux display-message -p '#S')}"
    local current_mode
    current_mode=$(get_left_panel_mode "$session")

    if [[ "$current_mode" == "$MODE_EXPLORER" ]]; then
        # Switch to git mode
        start_git_mode "$session"
    else
        # Switch back to explorer mode
        # First, kill the git log pane if it exists
        local git_log_pane
        git_log_pane=$(tmux show-environment -t "$session" TMUX_CODE_GIT_LOG_PANE 2>/dev/null | cut -d= -f2)
        if [[ -n "$git_log_pane" ]]; then
            # Kill the git log pane (it shifts other pane indices, but we target by ID)
            tmux kill-pane -t "${session}:0.${git_log_pane}" 2>/dev/null || true
            tmux set-environment -t "$session" -u TMUX_CODE_GIT_LOG_PANE
        fi

        # Start explorer mode
        start_explorer_mode "$session"
    fi
}

# ============================================================================
# Launch Commands in Panes (0h6.3.4)
# ============================================================================

# Launch detected commands in appropriate panes
# Arguments:
#   $1 - session name
#   $2 - layout type: "3col" | "2col" | "editor"
#   $3 - file explorer command (can be empty)
#   $4 - editor command (can be empty)
#   $5 - ai agent command (can be empty, only used for 3col)
launch_commands_in_panes() {
    local session="$1"
    local layout="$2"
    local explorer_cmd="$3"
    local editor_cmd="$4"
    local ai_cmd="${5:-}"

    case "$layout" in
        3col)
            # Pane 0: file explorer (explorer mode), Pane 1: editor, Pane 2: terminal, Pane 3: AI
            if [[ -n "$explorer_cmd" ]]; then
                tmux send-keys -t "${session}:0.0" "$explorer_cmd" Enter
                set_left_panel_mode "$session" "$MODE_EXPLORER"
            fi
            [[ -n "$editor_cmd" ]] && tmux send-keys -t "${session}:0.1" "$editor_cmd ." Enter
            # Pane 2 is terminal - leave as shell
            [[ -n "$ai_cmd" ]] && tmux send-keys -t "${session}:0.3" "$ai_cmd" Enter
            ;;
        2col)
            # Pane 0: file explorer (explorer mode), Pane 1: editor, Pane 2: terminal
            if [[ -n "$explorer_cmd" ]]; then
                tmux send-keys -t "${session}:0.0" "$explorer_cmd" Enter
                set_left_panel_mode "$session" "$MODE_EXPLORER"
            fi
            [[ -n "$editor_cmd" ]] && tmux send-keys -t "${session}:0.1" "$editor_cmd ." Enter
            # Pane 2 is terminal - leave as shell
            ;;
        editor)
            # Pane 0: editor, Pane 1: terminal (no left panel mode)
            [[ -n "$editor_cmd" ]] && tmux send-keys -t "${session}:0.0" "$editor_cmd ." Enter
            # Pane 1 is terminal - leave as shell
            ;;
    esac
}

# ============================================================================
# Layout Creation (0h6.2.1, 0h6.2.2, 0h6.2.3)
# ============================================================================

# Create 3-column layout with AI panel
# Layout: Left (15%) | Middle-Editor (50%) + Terminal | Right-AI (35%)
# Middle is split: Editor (70%) / Terminal (30%)
create_3_column_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window
    tmux new-session -d -s "$session" -c "$working_dir"

    # Split vertically: left (15%) | rest (85%)
    tmux split-window -h -l 85% -c "$working_dir"

    # Select right pane (pane 1), split vertically: middle (59%) | right (41%)
    # 59% of 85% ≈ 50% total, 41% of 85% ≈ 35% total
    tmux select-pane -t 1
    tmux split-window -h -l 41% -c "$working_dir"

    # Select middle pane (pane 1), split horizontally: editor (70%) | terminal (30%)
    tmux select-pane -t 1
    tmux split-window -v -l 30% -c "$working_dir"

    # Pane layout now:
    # Pane 0: Left (file explorer)
    # Pane 1: Middle-top (editor)
    # Pane 2: Middle-bottom (terminal)
    # Pane 3: Right (AI assistant)

    # Focus on editor pane
    tmux select-pane -t 1
}

# Create 2-column layout without AI panel (0h6.2.2)
# Layout: Left (20%) | Right-Editor (80%) + Terminal
# Right is split: Editor (70%) / Terminal (30%)
create_2_column_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window
    tmux new-session -d -s "$session" -c "$working_dir"

    # Split vertically: left (20%) | right (80%)
    tmux split-window -h -l 80% -c "$working_dir"

    # Select right pane (pane 1), split horizontally: editor (70%) | terminal (30%)
    tmux select-pane -t 1
    tmux split-window -v -l 30% -c "$working_dir"

    # Pane layout now:
    # Pane 0: Left (file explorer)
    # Pane 1: Right-top (editor)
    # Pane 2: Right-bottom (terminal)

    # Focus on editor pane
    tmux select-pane -t 1
}

# Create editor/terminal split layout (0h6.2.3)
# Simple 2-pane layout: Editor (70%) / Terminal (30%)
# Used when no file explorer is available
create_editor_terminal_layout() {
    local session="$1"
    local working_dir="$2"

    # Create session with first window
    tmux new-session -d -s "$session" -c "$working_dir"

    # Split horizontally: editor (70%) | terminal (30%)
    tmux split-window -v -l 30% -c "$working_dir"

    # Pane layout now:
    # Pane 0: Top (editor)
    # Pane 1: Bottom (terminal)

    # Focus on editor pane
    tmux select-pane -t 0
}

# ============================================================================
# Main Entry Point
# ============================================================================

main() {
    # Parse arguments
    parse_args "$@"

    # Handle help flag
    if [[ "$TMUX_CODE_HELP" == true ]]; then
        show_help
        return 0
    fi

    # Resolve to absolute path
    local abs_path
    abs_path=$(cd "$TMUX_CODE_PATH" && pwd)

    # Get session name
    local session_name
    session_name=$(get_session_name "$TMUX_CODE_PATH")

    # Check if session already exists (unless --new forces recreation)
    if tmux has-session -t "$session_name" 2>/dev/null; then
        if [[ "$TMUX_CODE_NEW" == true ]]; then
            echo "Killing session '$session_name'..."
            tmux kill-session -t "$session_name"
        else
            prompt_session_exists "$session_name"
            local action=$?

            case $action in
                0)  # Attach
                    tmux attach-session -t "$session_name"
                    return 0
                    ;;
                1)  # Recreate
                    echo "Killing session '$session_name'..."
                    tmux kill-session -t "$session_name"
                    ;;
                2)  # Cancel
                    echo "Cancelled."
                    return 0
                    ;;
            esac
        fi
    fi

    # Detect available tools
    local explorer_cmd
    local editor_cmd
    local ai_cmd
    explorer_cmd=$(detect_file_explorer)
    editor_cmd=$(detect_editor)

    # Handle AI agent: --no-agent disables, --agent overrides, otherwise auto-detect
    if [[ "$TMUX_CODE_NO_AGENT" == true ]]; then
        ai_cmd=""
    elif [[ -n "$TMUX_CODE_AGENT" ]]; then
        ai_cmd="$TMUX_CODE_AGENT"
    else
        ai_cmd=$(detect_ai_agent)
    fi

    # Determine layout based on available tools
    local layout
    if [[ -n "$ai_cmd" && -n "$explorer_cmd" ]]; then
        layout="3col"
    elif [[ -n "$explorer_cmd" ]]; then
        layout="2col"
    else
        layout="editor"
    fi

    # Create session with appropriate layout
    echo "Creating session: $session_name"
    case "$layout" in
        3col)
            create_3_column_layout "$session_name" "$abs_path"
            ;;
        2col)
            create_2_column_layout "$session_name" "$abs_path"
            ;;
        editor)
            create_editor_terminal_layout "$session_name" "$abs_path"
            ;;
    esac

    # Launch commands in panes
    launch_commands_in_panes "$session_name" "$layout" "$explorer_cmd" "$editor_cmd" "$ai_cmd"

    # Attach to session
    tmux attach-session -t "$session_name"
}

# Run main if script is executed directly (not sourced)
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
